pipeline:
  build:
    image: ryanhanwu/docker-meteor
    commands:
      - env
      - meteor npm install --allow-superuser
      - meteor npm run lint
      - meteor build --directory build --allow-superuser

  publish:
    image: plugins/docker
    username: alisonjc
    password: ${DOCKER_PASSWORD}
    email: alison.jane.c@gmail.com
    repo: alisonjc/schedulemaven
    tag:
      - latest
      - ${DRONE_BUILD_NUMBER}
    file: Dockerfile
    insecure: true
    when:
      branch: master

  deploy:
    image: peloton/drone-rancher
    url: http://rancher.seattleslow.com
    access_key: 8D080072A4397B6FE931
    secret_key: ${RANCHER_SECRET_KEY}
    service: schedulemaven/web
    docker_image: alisonjc/schedulemaven:${DRONE_BUILD_NUMBER}
    start_first: false
    confirm: true
    timeout: 180
    when:
      branch: master
